name: Run Ansible

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:

jobs:
  yake-ansible-site:
    runs-on: ubuntu-latest
    concurrency:
      group: ansible-${{ github.head_ref || github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ssh git curl ca-certificates

      - name: Install requirements
        run: |
          pip install -r requirements.txt
          ansible-galaxy install -f -r requirements.yml

      - name: Create group_vars/all.yml from ALL_YML_BASE64 secret
        id: create_all
        env:
          ALL_BASE64: ${{ secrets.ALL_YML_BASE64 }}
        run: |
          printf '%s' "$ALL_BASE64" | base64 -d > group_vars/all.yml
          chmod 600 group_vars/all.yml

      - name: Run ansible-playbook site.yml
        id: run_playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: ansible-playbook -i localhost, -c local site.yml -e "@group_vars/all.yml"

      - name: Check shoot status
        id: check_shoot_status
        env:
          SHOOT_NAME: managed-seed-1
          KUBECONFIG: /var/lib/yake/gardener-operator/kubeconfig.vgarden
        run: |
          status=$(kubectl get shoot $SHOOT_NAME -o jsonpath='{.metadata.labels.shoot\.gardener\.cloud/status}')
          echo "Shoot Status Label: $status"

          if [ "$status" != "healthy" ]; then
            echo "Shoot not healthy! Status: $status"
            exit 1
          fi

          conditions=("APIServerAvailable" "ControlPlaneHealthy" "EveryNodeReady" "ObservabilityComponentsHealthy" "SystemComponentsHealthy")
          for cond in "${conditions[@]}"; do
            cond_status=$(kubectl get shoot $SHOOT_NAME -o jsonpath="{.status.conditions[?(@.type=='$cond')].status}")
            echo "$cond Status: $cond_status"
            if [ "$cond_status" != "True" ]; then
              echo "Condition $cond is not True"
              exit 1
            fi
          done

          echo "Shoot is healthy"

      - name: Annotate, delete and wait for shoot deletion
        if: always()
        run: |
          export KUBECONFIG=/var/lib/yake/gardener-operator/kubeconfig.vgarden
          ./.local/yake-kubectl annotate shoot managed-seed-1 -n garden confirmation.gardener.cloud/deletion=true --overwrite
          ./.local/yake-kubectl delete managedseed managed-seed-1 -n garden
          ./.local/yake-kubectl delete shoot managed-seed-1 -n garden
          for i in {1..20}; do
            if ! ./.local/yake-kubectl get shoot managed-seed-1 -n garden >/dev/null 2>&1; then
              echo "Shoot deleted."
              exit 0
            else
              echo "Shoot still running, wait 30 seconds..."
              sleep 30
            fi
          done
          echo "Timeout: Shoot could not deleted within 10 minutes."
          exit 1

      - name: Delete all clusters and files
        if: always()
        run: |
          export KUBECONFIG=/var/lib/yake/kubeconfig.clusterapi
          ./.local/yake-kubectl delete cluster garden
          ./.local/yake-kind delete cluster --name clusterapi
          docker rm -f $(docker ps -qa)
          sudo rm -rf /var/lib/yake/
          sudo rm -f group_vars/all.yml
